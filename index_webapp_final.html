<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Гра "Скриньки" - Мультиплеер</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
        .game-container { background-color: white; border-radius: 10px; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .card { display: inline-block; padding: 5px 10px; margin: 5px; border: 1px solid #ddd; border-radius: 5px; background-color: white; cursor: pointer; }
        .card.selected { background-color: #d4edda; border-color: #c3e6cb; }
        .hearts, .diamonds { color: red; }
        .clubs, .spades { color: black; }
        .controls { margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 5px; }
        button { padding: 8px 15px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .suit-btn { font-size: 20px; width: 40px; height: 40px; }
        .game-info, .players-list { margin-bottom: 20px; }
        .player-info { border-bottom: 1px solid #eee; padding: 5px 0; }
        .box { display: inline-block; padding: 5px 10px; margin: 5px; border: 1px solid #17a2b8; border-radius: 5px; background-color: #d1ecf1; }
        .game-log { margin-top: 20px; padding: 10px; background-color: #f8f9fa; border-radius: 5px; max-height: 200px; overflow-y: auto; }
        .log-entry { margin: 5px 0; padding: 5px; border-bottom: 1px solid #eee; }
        .system-log { font-weight: bold; color: #28a745; }
        .turn-log { color: #007bff; }
        .error-log { color: #dc3545; }
        .lobby { text-align: center; }
        .game-over-modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 10px; text-align: center; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        #my-hand h3 { margin-bottom: 0; }
        #opponent-selection { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Гра "Скриньки"</h1>

        <div id="lobby-view" class="lobby">
            <h2>Ласкаво просимо!</h2>
            <p>Введіть ваше ім'я та приєднайтесь до гри.</p>
            <input type="text" id="player-name-input" placeholder="Ваше ім'я" required><br><br>
            <input type="text" id="room-id-input" placeholder="ID кімнати (необов'язково)">
            <button id="join-btn">Приєднатися</button>
            <br>
            <p id="room-info" style="margin-top: 10px;"></p>
        </div>

        <div id="game-view" style="display: none;">
            <div id="players-list" class="game-info">
                <h3>Гравці в кімнаті (<span id="player-count">0</span>)</h3>
                <ul id="players-ul"></ul>
            </div>
            <button id="start-game-btn" style="display: none;">Почати гру</button>

            <div id="game-started-view" style="display: none;">
                <div class="game-info">
                    <h3>Поточний гравець: <span id="current-player"></span></h3>
                    <p>Карт у колоді: <span id="deck-count"></span></p>
                </div>

                <div id="my-hand">
                    <h3>Ваші карти:</h3>
                    <div id="my-cards"></div>
                </div>

                <div class="controls" id="player-controls">
                    <div id="opponent-selection">
                        <p>Оберіть опонента:</p>
                        <select id="opponent-select"></select>
                    </div>
                    <div id="rank-selection">
                        <p>Оберіть номінал:</p>
                        <div id="rank-buttons"></div>
                    </div>
                    <div id="count-selection" style="display: none;">
                        <p>Оберіть кількість:</p>
                        <button class="count-btn" data-count="1">1</button>
                        <button class="count-btn" data-count="2">2</button>
                        <button class="count-btn" data-count="3">3</button>
                        <button class="count-btn" data-count="4">4</button>
                    </div>
                    <div id="suit-selection" style="display: none;">
                        <p>Оберіть масті:</p>
                        <button class="suit-btn hearts" data-suit="♥">♥</button>
                        <button class="suit-btn diamonds" data-suit="♦">♦</button>
                        <button class="suit-btn clubs" data-suit="♣">♣</button>
                        <button class="suit-btn spades" data-suit="♠">♠</button>
                        <div id="selected-suits-display"></div>
                        <button id="submit-request" disabled>Підтвердити запит</button>
                    </div>
                </div>
            </div>
            
            <div class="game-log">
                <h3>Історія гри:</h3>
                <div id="game-history"></div>
            </div>
        </div>
    </div>
    
    <div id="game-over-modal" class="game-over-modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Гра завершена!</h2>
            <div id="game-result"></div>
            <button id="play-again-btn">Грати знову</button>
        </div>
    </div>

   <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        const WS_URL = "wss://telegram-webapp-beispiel.onrender.com"; 
        let playerName = '';
        let roomID = null;
        let gameState = null;
        let playerHand = [];
        let currentPlayer = '';
        let currentStep = 'ask_rank';
        let turnState = {};

        const elements = {
            lobbyView: document.getElementById('lobby-view'),
            gameView: document.getElementById('game-view'),
            playerNameInput: document.getElementById('player-name-input'),
            roomIdInput: document.getElementById('room-id-input'),
            joinBtn: document.getElementById('join-btn'),
            roomInfo: document.getElementById('room-info'),
            playersUl: document.getElementById('players-ul'),
            playerCount: document.getElementById('player-count'),
            startGameBtn: document.getElementById('start-game-btn'),
            gameStartedView: document.getElementById('game-started-view'),
            currentPlayerDisplay: document.getElementById('current-player'),
            deckCount: document.getElementById('deck-count'),
            myCards: document.getElementById('my-cards'),
            playerControls: document.getElementById('player-controls'),
            opponentSelect: document.getElementById('opponent-select'),
            rankSelection: document.getElementById('rank-selection'),
            rankButtons: document.getElementById('rank-buttons'),
            countSelection: document.getElementById('count-selection'),
            suitSelection: document.getElementById('suit-selection'),
            selectedSuitsDisplay: document.getElementById('selected-suits-display'),
            submitRequestBtn: document.getElementById('submit-request'),
            gameHistory: document.getElementById('game-history'),
            gameOverModal: document.getElementById('game-over-modal'),
            gameResult: document.getElementById('game-result'),
            playAgainBtn: document.getElementById('play-again-btn'),
            closeModal: document.querySelector('.close')
        };
		
		if (tg) {
            tg.ready();
            tg.expand();
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const u = tg.initDataUnsafe.user;
                telegramUser = u.username ? `@${u.username}` : (u.first_name || 'Гравець');
                elements.playerNameInput.value = telegramUser;
            } else {
                telegramUser = "Анонімний гравець";
            }
        } else {
            telegramUser = "Тестовий гравець";
        }

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log("Received:", data);

            switch (data.type) {
                case 'room_created':
                    roomID = data.room_id;
                    elements.roomInfo.textContent = `Кімнату створено. ID: ${roomID}. Очікування гравців...`;
                    break;
                case 'room_state':
                    updateLobbyView(data);
                    break;
                case 'game_started':
                case 'state_update': // Після успішного ходу гравця сервер повертає state_update
                    gameState = data.state;
                    playerHand = data.hand;
                    currentPlayer = data.state.currentPlayer;
                    
                    if (playerName === currentPlayer) {
                        currentStep = 'ask_rank'; // Скидаємо крок на початковий, щоб гравець міг продовжити хід
                        turnState = {}; // Очищаємо стан ходу
                    }

                    updateUI();
                    break;
                case 'next_step':
                    currentStep = data.step;
                    turnState = { opponent: data.opponent, rank: data.rank, count: data.count };
                    playerHand = data.hand;
                    updateUI();
                    break;
                case 'game_over':
                    gameState = data.state;
                    showGameOverModal(data.state, data.winners);
                    break;
                case 'info':
                    addLogEntry(data.message, 'system');
                    break;
                case 'error':
                    addLogEntry(`Помилка: ${data.message}`, 'error');
                    break;
            }
        };

        ws.onopen = function() {
            console.log("Connected to WebSocket server.");
        };

        ws.onclose = function() {
            addLogEntry("З'єднання з сервером втрачено.", 'error');
        };

        elements.joinBtn.addEventListener('click', () => {
            playerName = elements.playerNameInput.value.trim();
            roomID = elements.roomIdInput.value.trim();

            if (playerName) {
                const joinMessage = {
                    action: "join",
                    name: playerName,
                    room_id: roomID || null
                };
                ws.send(JSON.stringify(joinMessage));
                elements.lobbyView.style.display = 'none';
                elements.gameView.style.display = 'block';
            }
        });

        elements.startGameBtn.addEventListener('click', () => {
            const startMessage = { action: "start_game" };
            ws.send(JSON.stringify(startMessage));
        });

        elements.rankButtons.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.rank) {
                const rank = e.target.dataset.rank;
                const opponent = elements.opponentSelect.value;
                if (!opponent) {
                    addLogEntry("Оберіть опонента!", 'error');
                    return;
                }
                const turnMessage = { action: "make_turn", step: "ask_rank", opponent, rank };
                ws.send(JSON.stringify(turnMessage));
            }
        });

        document.querySelectorAll('.count-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const guess = parseInt(btn.dataset.count);
                const turnMessage = { action: "make_turn", step: "guess_count", opponent: turnState.opponent, rank: turnState.rank, guess };
                ws.send(JSON.stringify(turnMessage));
            });
        });

        const selectedSuits = new Set();
        document.querySelectorAll('.suit-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const suit = btn.dataset.suit;
                if (selectedSuits.has(suit)) {
                    selectedSuits.delete(suit);
                    btn.classList.remove('selected');
                } else if (selectedSuits.size < turnState.count) {
                    selectedSuits.add(suit);
                    btn.classList.add('selected');
                }
                updateSelectedSuitsDisplay();
                updateSubmitButtonState();
            });
        });

        elements.submitRequestBtn.addEventListener('click', () => {
            if (selectedSuits.size === turnState.count) {
                const turnMessage = { action: "make_turn", step: "guess_suits", opponent: turnState.opponent, rank: turnState.rank, suits: Array.from(selectedSuits) };
                ws.send(JSON.stringify(turnMessage));
                selectedSuits.clear();
                document.querySelectorAll('.suit-btn').forEach(btn => btn.classList.remove('selected'));
                updateSubmitButtonState();
            }
        });

        elements.playAgainBtn.addEventListener('click', () => {
            window.location.reload();
        });

        elements.closeModal.addEventListener('click', () => {
            elements.gameOverModal.style.display = 'none';
        });

        function updateLobbyView(data) {
            elements.playersUl.innerHTML = '';
            elements.playerCount.textContent = data.players.length;
            data.players.forEach(p => {
                const li = document.createElement('li');
                li.textContent = p;
                elements.playersUl.appendChild(li);
            });

            if (data.players.length >= 2) {
                elements.startGameBtn.style.display = 'block';
            } else {
                elements.startGameBtn.style.display = 'none';
            }
        }

        function updateUI() {
            if (!gameState) return;

            elements.gameStartedView.style.display = 'block';
            elements.currentPlayerDisplay.textContent = gameState.currentPlayer;
            elements.deckCount.textContent = gameState.deckCount;

            updatePlayerHands();
            updatePlayerInfo();
            updateHistory();
            updateControls();
        }

        function updatePlayerHands() {
            elements.myCards.innerHTML = '';
            const myHand = playerHand || [];
            myHand.sort().forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card';
                cardElement.textContent = card;
                const suit = card.slice(-1);
                cardElement.classList.add(suit === '♥' || suit === '♦' ? 'hearts' : 'clubs');
                elements.myCards.appendChild(cardElement);
            });
        }

        function updatePlayerInfo() {
            elements.playersUl.innerHTML = '';
            elements.opponentSelect.innerHTML = '';

            gameState.players.forEach(p => {
                const li = document.createElement('li');
                li.className = 'player-info';
                let boxes = gameState.collectedBoxes[p].length;
                let handSize = gameState.hands[p].length;
                let infoText = `${p}: Скриньок: ${boxes} (${gameState.collectedBoxes[p].join(', ')}), Карт: ${handSize}`;
                
                if (p === playerName) {
                    infoText += " (Ви)";
                }

                li.textContent = infoText;
                elements.playersUl.appendChild(li);

                if (p !== playerName) {
                    const option = document.createElement('option');
                    option.value = p;
                    option.textContent = p;
                    elements.opponentSelect.appendChild(option);
                }
            });
        }

        function updateHistory() {
            elements.gameHistory.innerHTML = '';
            gameState.history.forEach(entry => {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${entry.type}-log`;
                logEntry.textContent = entry.message;
                elements.gameHistory.appendChild(logEntry);
            });
            elements.gameHistory.scrollTop = elements.gameHistory.scrollHeight;
        }

        function updateControls() {
            const isMyTurn = (playerName === gameState.currentPlayer);
            elements.playerControls.style.display = isMyTurn ? 'block' : 'none';

            if (isMyTurn) {
                if (currentStep === 'ask_rank') {
                    elements.rankSelection.style.display = 'block';
                    elements.countSelection.style.display = 'none';
                    elements.suitSelection.style.display = 'none';
                    setupRankButtons();
                } else if (currentStep === 'guess_count') {
                    elements.rankSelection.style.display = 'none';
                    elements.countSelection.style.display = 'block';
                    elements.suitSelection.style.display = 'none';
                } else if (currentStep === 'guess_suits') {
                    elements.rankSelection.style.display = 'none';
                    elements.countSelection.style.display = 'none';
                    elements.suitSelection.style.display = 'block';
                    updateSubmitButtonState();
                }
            } else {
                currentStep = 'ask_rank';
            }
        }

        function setupRankButtons() {
            if (!gameState) return;
            elements.rankButtons.innerHTML = '';
            
            const allRanks = ['6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
            const availableRanks = allRanks.filter(rank => {
                // Перевіряємо, чи номінал вже зібраний будь-яким гравцем
                return !Object.values(gameState.collectedBoxes).some(boxes => boxes.includes(rank));
            });

            availableRanks.forEach(rank => {
                const btn = document.createElement('button');
                btn.textContent = rank;
                btn.dataset.rank = rank;
                elements.rankButtons.appendChild(btn);
            });
        }

        function updateSelectedSuitsDisplay() {
            const suits = Array.from(selectedSuits);
            elements.selectedSuitsDisplay.innerHTML = 'Вибрано мастей: ' + suits.map(suit => {
                const colorClass = (suit === '♥' || suit === '♦') ? 'hearts' : 'clubs';
                return `<span class="${colorClass}">${suit}</span>`;
            }).join(', ');
        }

        function updateSubmitButtonState() {
            elements.submitRequestBtn.disabled = selectedSuits.size !== turnState.count;
        }

        // cd /d "D:\Skrunka_Bot_TELEGRAM"
		  
		function showGameOverModal(state, winners) { 
            const modal = document.getElementById("game-over-modal");
            const gameResultDiv = document.getElementById("game-result");

            let resultHTML = "<h3>Результати:</h3>";

            // Підсумки по кожному гравцю
            for (const player of state.players) {
            const boxes = state.boxes[player];
            const collected = state.collectedBoxes[player].join(', ');
                resultHTML += `<p>${player}: ${boxes} скриньок (${collected})</p>`;
            }

            const totalPlayers = state.players.length;

            // Додаємо емодзі 🏆 біля переможців
            const winnersWithTrophy = winners.map(name => `🏆 ${name}`);

            // Масиви варіантів повідомлень
            const singleWinnerMsgs = [
                `Переможець: ${winnersWithTrophy[0]}!`,
                `Чемпіон цього раунду — ${winnersWithTrophy[0]}!`,
                `Беззаперечний лідер: ${winnersWithTrophy[0]}!`
            ];

            const fullTieMsgs = [
                `Нічия! Всі грали добре і рівні між собою: ${winnersWithTrophy.join(', ')}!`,
                `Повна рівність! ${winnersWithTrophy.join(', ')} поділили перше місце!`,
                `Жодного явного лідера — усі переможці: ${winnersWithTrophy.join(', ')}!`
            ];

            const partialTieMsgs = [
                `Перемогу розділяють: ${winnersWithTrophy.join(', ')}!`,
                `Лідери цього раунду: ${winnersWithTrophy.join(', ')}!`,
                `Декілька гравців вийшли на вершину: ${winnersWithTrophy.join(', ')}!`
            ];

            const noWinnerMsgs = [
                `Переможця не визначено!`,
                `Ніхто не здобув перемоги цього разу.`,
                `Цього разу гра закінчилась без лідера.`
            ];

            // Функція для вибору випадкового повідомлення
            function randomMsg(arr) {
                return arr[Math.floor(Math.random() * arr.length)];
            }

            // Логіка вибору повідомлення
            if (!winners || winners.length === 0) {
                resultHTML += `<h3>${randomMsg(noWinnerMsgs)}</h3>`;
            } else if (winners.length === 1) {
                resultHTML += `<h3>${randomMsg(singleWinnerMsgs)}</h3>`;
            } else if (winners.length === totalPlayers && totalPlayers === 3) {
                resultHTML += `<h3>${randomMsg(fullTieMsgs)}</h3>`;
            } else {
                resultHTML += `<h3>${randomMsg(partialTieMsgs)}</h3>`;
            }

                gameResultDiv.innerHTML = resultHTML;
                modal.style.display = "block";
        }

        function addLogEntry(message, type) {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}-log`;
            logEntry.textContent = message;
            elements.gameHistory.appendChild(logEntry);
            elements.gameHistory.scrollTop = elements.gameHistory.scrollHeight;
        }

        window.onload = function() {
            if (window.location.protocol !== 'http:' && window.location.protocol !== 'https:') {
                console.warn("WebSocket client must be served over HTTP or HTTPS.");
            }
        };
    </script>
</body>
</html>

