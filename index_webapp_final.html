<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Гра "Скриньки"</title>
    <style>
body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
        background-color: #f0f0f0; 
        margin: 0; 
        padding: 20px; 
        text-align: center; 
    }
		
    .game-container { 
        max-width: 800px; 
        margin: auto; 
        background: #fff; 
        padding: 20px; 
        border-radius: 8px; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
    }

    /* 🔹 Центрування лобі */
    #lobby {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        text-align: center;
    }

    /* 🔹 Центрування та охайний вигляд блоку гри */
    #game {
        display: flex;
        flex-direction: column;
        align-items: center;   /* центрує всі елементи горизонтально */
        text-align: center;    /* вирівнює текст */
        gap: 1em;              /* проміжок між секціями */
        margin: 0 auto;        /* центрування по ширині */
        max-width: 800px;      /* обмеження ширини для великих екранів */
        width: 100%;           /* адаптивність */
        padding: 1em;          /* невеликий внутрішній відступ */
    }

    /* 🔹 Панель керування */
    #controls {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.8em;
        width: 100%;
    }

    /* 🔹 Підблоки з діями */
    #game-actions,
    #guess-count,
    #guess-suits-form,
    #response-buttons {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5em;
    }

    /* 🔹 Рука гравця */
    #player-hand {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.5em;
    }

    /* 🔹 Зібрані скриньки */
    #collected-boxes {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5em;
    }

    /* 🔹 Список гравців */
    #players-list {
        list-style: none;
        padding: 0;
        margin: 0;
        text-align: center;
    }
    #players-list li {
        margin: 0.3em 0;
    }

    /* 🔹 Журнал */
    #log {
        text-align: left;
        max-height: 200px;
        overflow-y: auto;
        border-radius: 5px;
    }

    /* 🔹 Карти */
    .card-container { 
        display: flex; 
        flex-wrap: wrap; 
        justify-content: center; 
        gap: 8px; 
        margin-top: 15px; 
    }
    .card { 
        width: 55px; 
        height: 80px; 
        border: 1px solid #ccc; 
        border-radius: 5px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 1.1em; 
        font-weight: bold; 
        background-color: white; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        transition: transform 0.2s ease-in-out; 
    }
    .card:hover { transform: translateY(-3px); }
    .hearts, .diamonds { color: red; }
    .clubs, .spades { color: black; }

    /* 🔹 Інші дрібні стилі */
    .game-state-message { font-size: 1.2em; margin-bottom: 15px; font-weight: bold; }
    button, select, input { padding: 8px 15px; margin: 4px; font-size: 0.9em; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
    button:hover { background-color: #e9e9e9; }
    button:active { background-color: #dcdcdc; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    .collected-boxes { margin-top: 15px; text-align: left; font-size: 0.9em; }
    .hidden { display: none !important; }
    .lobby-inputs input { width: 180px; }
    .lobby-inputs button { width: 370px; }
    h1 { margin-bottom: 10px; }
    p { margin: 5px 0; }
    ul { list-style-type: none; padding: 0; }
    ul li { margin: 3px 0; font-size: 0.9em; }
    #game-info { text-align: center; margin-top: 20px; }
    #suits-checkboxes { 
        margin-bottom: 2em;
        display: flex;
        justify-content: space-around;
        max-width: 400px;
        margin: 0 auto 2em auto;
    }
    #response-buttons {
        display: flex;
        justify-content: space-around;
        gap: 1em;
        margin-top: 1em;
    }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Гра "Скриньки"</h1>

        <div id="lobby">
            <p>Виберіть ім'я та кімнату для гри.</p>
            <input type="text" id="player-name-input" placeholder="Ваше ім'я">
            <input type="text" id="room-id-input" placeholder="ID кімнати">
            <button onclick="joinRoom()">Приєднатися / Створити кімнату</button>
            <p id="lobby-message"></p>
        </div>

        <div id="game" style="display: none;">
            <div class="game-state-message" id="game-status">Очікування на гравців...</div>
            
            <div id="controls">
                <div id="game-actions" style="display: none;">
                    <p>Ваш хід, <span id="current-player-name"></span>! Виберіть гравця та карту для запиту.</p>
                    <select id="target-player-select"></select>
                    <select id="card-rank-select">
                        <option value="">Вибрати значення</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="J">J</option>
                        <option value="Q">Q</option>
                        <option value="K">K</option>
                        <option value="A">A</option>
                    </select>
                    <button onclick="askForCard()">Запитати</button>
                </div>


                <div id="guess-count" style="display: none;">
                    <p>Вгадайте, скільки карт з цим рангом є у вашого суперника?</p>
                       <select id="card-count-select">  
                           <option value="">Вибрати значення</option>  
                           <option value="1">1</option>  
                           <option value="2">2</option>  
                           <option value="3">3</option>   
                       </select>   
                    <button id="submit-guess-count-btn">Відправити</button>
                </div>
                
                <div id="guess-suits-form" style="display: none;">
                    <p>Скільки мастей ви вгадаєте?</p>
                    <div id="suits-checkboxes">
                        <label><input type="checkbox" name="suit" value="♥"> ♥</label>
                        <label><input type="checkbox" name="suit" value="♦"> ♦</label>
                        <label><input type="checkbox" name="suit" value="♣"> ♣</label>
                        <label><input type="checkbox" name="suit" value="♠"> ♠</label>
                    </div>
                    <button onclick="guessSuits()">Вгадати масті</button>
                </div>

                <div id="response-buttons" style="display: none;">
                    <p>Гравець <span id="asking-player-name"></span> запитує карту <span id="asked-card-rank"></span>. У вас вона є?</p>
                    <button onclick="respondToAsk('yes')">Так</button>
                    <button onclick="respondToAsk('no')">Ні</button>
                </div>
            </div>

            <div id="game-info">
                <button id="startGameBtn" onclick="startGame()" >Розпочати гру</button>
                <p><strong>Ваші карти:</strong></p>
                <div id="player-hand" class="card-container"></div>
                <p><strong>Зібрані скриньки:</strong></p>
                <div id="collected-boxes" class="collected-boxes"></div>
                <p><strong>Колода:</strong> <span id="deck-size"></span> карт</p>
                <p><strong>Гравці:</strong></p>
                <ul id="players-list"></ul>
            </div>
        </div>
        
        <div class="message-box">
            <h4>Журнал гри:</h4>
            <div id="log"></div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        const WS_URL = "wss://telegram-webapp-beispiel.onrender.com"; // !!! Змініть на публічну адресу вашого сервера !!!
        let socket;
        let telegramUser = '';
        let myName = '';
        let myRoomId = '';
        let myCards = [];
        // Лічильник для контролю, щоб game_over оброблявся лише один раз
        let gameOverHandled = false;
		
        const elements = {
            lobby: document.getElementById('lobby'),
            game: document.getElementById('game'),
            playerNameInput: document.getElementById('player-name-input'),
            roomIdInput: document.getElementById('room-id-input'),
            lobbyMessage: document.getElementById('lobby-message'),
            gameStatus: document.getElementById('game-status'),
            startGameBtn: document.getElementById('startGameBtn'),
            gameActions: document.getElementById('game-actions'),
            playerHand: document.getElementById('player-hand'),
            collectedBoxes: document.getElementById('collected-boxes'),
            playersList: document.getElementById('players-list'),
            deckSize: document.getElementById('deck-size'),
            log: document.getElementById('log'),
            targetPlayerSelect: document.getElementById('target-player-select'),
            cardRankSelect: document.getElementById('card-rank-select'),
            guessSuitsForm: document.getElementById('guess-suits-form'),
            guessCount: document.getElementById('guess-count'),
            guessCountInput: document.getElementById('card-count-select'),
            submitGuessCountBtn: document.getElementById('submit-guess-count-btn'),
            suitsCheckboxes: document.getElementById('suits-checkboxes'),
            responseButtons: document.getElementById('response-buttons'),
            askingPlayerName: document.getElementById('asking-player-name'),
            askedCardRank: document.getElementById('asked-card-rank'),
            currentPlayerName: document.getElementById('current-player-name') // Додано
        };

        if (tg) {
            tg.ready();
            tg.expand();
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const u = tg.initDataUnsafe.user;
                telegramUser = u.username ? `@${u.username}` : (u.first_name || 'Гравець');
                elements.playerNameInput.value = telegramUser;
            } else {
                telegramUser = "Анонімний гравець";
            }
        } else {
            telegramUser = "Тестовий гравець";
        }

        function logMessage(message) {
            const now = new Date();
            const dateStr = now.toLocaleDateString();   // локальна дата, напр. 25.08.2025
            const timeStr = now.toLocaleTimeString();   // локальний час, напр. 14:35:12
            const p = document.createElement('p');
            p.textContent = `[${dateStr} ${timeStr}] ${message}`;
            elements.log.appendChild(p);
            elements.log.scrollTop = elements.log.scrollHeight;
        }


        function updateUI(state, myHand) {
            // Оновлення списку гравців з їхніми скриньками
            elements.playersList.innerHTML = '';
            state.players.forEach(p => {
                const li = document.createElement('li');

                // Формуємо текст з інформацією про зібрані скриньки
                const collectedSetsText = p.collected_sets.length > 0
                    ? ` (${p.collected_sets.join(', ')})`
                    : '';

                li.textContent = `${p.name} (${p.is_turn ? 'Ходить' : 'Очікує'}) - Скриньок: ${p.collected_boxes}${collectedSetsText}`;
                elements.playersList.appendChild(li);
            });

            // Оновлення імені поточного гравця
            elements.currentPlayerName.textContent = state.current_turn;

            // Використовуємо myHand, переданий як аргумент
            elements.playerHand.innerHTML = '';
            if (myHand && myHand.length > 0) {
                myHand.forEach(card => {
                    const div = document.createElement('div');
                    // Перевіряємо масті для кольору
                    const isRedSuit = card.includes('♥') || card.includes('♦');
                    div.className = `card ${isRedSuit ? 'hearts' : 'clubs'}`;
                    div.textContent = card;
                    elements.playerHand.appendChild(div);
                });
            }

    // Видаляємо цей блок коду, оскільки він застарів
    // Ми тепер відображаємо скриньки в playersList
    // elements.collectedBoxes.innerHTML = '';
    // state.players.find(p => p.name === myName)?.collected_sets.forEach(rank => {
    //     const p = document.createElement('p');
    //     p.textContent = `Зібрано скриньку: ${rank}`;
    //     elements.collectedBoxes.appendChild(p);
    // });
    
            // Оновлення розміру колоди
            elements.deckSize.textContent = state.deck_size;
    
            // Оновлення статусу гри
            elements.gameStatus.textContent = state.game_started 
               ? `Гра розпочалась! Хід гравця: ${state.current_turn}` 
               : `Очікування на гравців... (Всього ${state.players.length}/6)`;

            handleStartGameButton(state);
            hideAllControls();

            const myPlayerState = state.players.find(p => p.name === myName);
            if (state.game_started && state.current_turn === myName) {
                elements.gameActions.style.display = 'block';
                elements.targetPlayerSelect.innerHTML = state.players
                    .filter(p => p.name !== myName)
                    .map(p => `<option value="${p.name}">${p.name}</option>`)
                    .join('');
            }
        }

        function handleStartGameButton(state) {
            const isRoomAdmin = state.room_admin === myName;
            
            if (isRoomAdmin && !state.game_started) {
                elements.startGameBtn.style.display = 'block';
                elements.startGameBtn.disabled = state.players.length < 2;
            } else {
                elements.startGameBtn.style.display = 'none';
            }
        }

        function hideAllControls() {
            elements.gameActions.style.display = 'none';
            //elements.guessCount.style.display = 'none';
            //elements.guessSuitsForm.style.display = 'none';
            elements.responseButtons.style.display = 'none';
        }

        function joinRoom() {
            myName = elements.playerNameInput.value.trim();
            myRoomId = elements.roomIdInput.value.trim();

            if (myName && myRoomId) {
                connectWebSocket();
            } else {
                elements.lobbyMessage.textContent = 'Будь ласка, введіть ім\'я та ID кімнати.';
            }
        }

        function addLogEntry(message, type) {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}-log`;
            logEntry.textContent = message;
            elements.log.appendChild(logEntry);  // <--- ВИПРАВЛЕНО ТУТ
            elements.log.scrollTop = elements.log.scrollHeight; // <--- ВИПРАВЛЕНО ТУТ
        }

		// Функція для обробки завершення гри
        function handleGameOver(data) {
            if (gameOverHandled) return; // якщо вже виконувалось – вийти
            gameOverHandled = true;

            logMessage(`🏆 Гра завершена! Переможець: ${data.winner}.`);
    
            // Відображення повідомлення
            //window.alert("🏆 " + data.message);

            // Формування результатів
            const resultsHtml = data.results.map(p => {
                return `${p.name}: ${p.score} скриньок`;
            }).join('\n');

            // Оновлення модального вікна (тут поки через alert)
            const modalContent = `🏆 ${data.message}\n\nРезультати гри:\n${resultsHtml}`;
            window.alert(modalContent);

            window.alert("Для нової гри перезавантажте бот та зареєструйтеся заново");
        }
		
        function connectWebSocket() {
            socket = new WebSocket(WS_URL);
            
            socket.onopen = () => {
                logMessage("Підключено до сервера. Надсилаємо ім'я гравця та ID кімнати...");
                // Новий, виправлений код:
                   const message_to_send = { type: 'join', name: myName, room: myRoomId };
                                                    //addLogEntry(`Надсилаю: ${JSON.stringify(message_to_send)}`, 'system');
                   socket.send(JSON.stringify(message_to_send));
                   };
            
            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                                                      //logMessage(`Отримано: ${event.data}`);
                
                switch (data.type) {
                    case 'joined_room':
                        elements.lobby.style.display = 'none';
                        elements.game.style.display = 'block';
                        logMessage(`Приєднано до кімнати: ${myRoomId}`);
                        break;
                    case 'update_state':
                        updateUI(data.state, data.state.my_hand);
                        break;
                    case 'start_game':
                        logMessage('Гра розпочалась!');
                        break;
                    case 'game_over':
                        handleGameOver(data); // викликаємо окрему функцію
                        break;
                    case 'ask_response_needed':
                        hideAllControls();
                        elements.responseButtons.style.display = 'block';
                        elements.askingPlayerName.textContent = data.asking_player;
                        elements.askedCardRank.textContent = data.card_rank;
                        break;
                    case 'guess_count_needed':
                        hideAllControls();
                        elements.guessCount.style.display = 'block';
                        break;
                    case 'guess_suits_needed':
                        hideAllControls();
                        elements.guessSuitsForm.style.display = 'block';
                        break;
                    case 'log':
                        logMessage(data.message);
                        break;
                    case 'error':
                        logMessage(`Помилка: ${data.message}`);
                        break;
                }
            };

            socket.onclose = () => {
                logMessage("Відключено від сервера. Спроба перепідключення через 5 секунд...");
                setTimeout(connectWebSocket, 5000);
            };
            
            socket.onerror = (error) => {
                logMessage(`Помилка WebSocket: ${error}`);
            };
        }

        function startGame() {
            if (socket.readyState === WebSocket.OPEN) {
                  const message_to_send = { type: 'start_game', room: myRoomId };
                // Логуємо повідомлення перед відправкою
                                                    //addLogEntry(`Надсилаю: ${JSON.stringify(message_to_send)}`, 'system');
                 // Відправляємо повідомлення
                socket.send(JSON.stringify(message_to_send));
            }
        }

        function askForCard() {
            const targetPlayer = elements.targetPlayerSelect.value;
            const cardRank = elements.cardRankSelect.value;
            if (targetPlayer && cardRank) {
                  const message_to_send = {type: 'ask_card', room: myRoomId, target: targetPlayer, card_rank: cardRank };
                // Логуємо повідомлення перед відправкою
                                                    //addLogEntry(`Надсилаю: ${JSON.stringify(message_to_send)}`, 'system');
               // Відправляємо повідомлення
                  socket.send(JSON.stringify(message_to_send)); 
            } else {
                logMessage('Будь ласка, виберіть гравця та значення карти.');
            }
        }
        
        function respondToAsk(response) {
            socket.send(JSON.stringify({ type: 'ask_response', room: myRoomId, response: response }));
            hideAllControls();
        }

        function guessSuits() {
            const suits = Array.from(elements.suitsCheckboxes.querySelectorAll('input:checked')).map(cb => cb.value);
            if (suits.length > 0) {
                const message_to_send = { type: 'guess_suits', room: myRoomId, suits: suits };
                // Логуємо повідомлення перед відправкою
                                                    //addLogEntry(`Надсилаю: ${JSON.stringify(message_to_send)}`, 'system');
               // Відправляємо повідомлення
                socket.send(JSON.stringify(message_to_send));
                elements.guessSuitsForm.style.display = 'none';
            } else {
                logMessage('Будь ласка, виберіть масті.');
            }
        }

      // Додайте обробник подій для нової кнопки
      elements.submitGuessCountBtn.onclick = () => {
      const count = parseInt(elements.guessCountInput.value, 10);

      if (!isNaN(count)) {
          const message_to_send = { type: 'guess_count', room: myRoomId, count: count };
          // Логуємо повідомлення перед відправкою
                                                     //addLogEntry(`Надсилаю: ${JSON.stringify(message_to_send)}`, 'system');    
          // Відправляємо повідомлення
          socket.send(JSON.stringify(message_to_send));
          elements.guessCount.style.display = 'none'; // ховаємо форму після відправки
      } else {
          logMessage('Будь ласка, виберіть кількість.');
      }
  };



            
    </script>
</body>
</html>
