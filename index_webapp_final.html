<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–ì—Ä–∞ "–°–∫—Ä–∏–Ω—å–∫–∏"</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f0f0f0; margin: 0; padding: 20px; text-align: center; }
        .game-container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 15px; }
        .card { width: 55px; height: 80px; border: 1px solid #ccc; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 1.1em; font-weight: bold; background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s ease-in-out; }
        .card:hover { transform: translateY(-3px); }
        .hearts, .diamonds { color: red; }
        .clubs, .spades { color: black; }
        .game-state-message { font-size: 1.2em; margin-bottom: 15px; font-weight: bold; }
        #log { max-height: 150px; overflow-y: scroll; border: 1px solid #ddd; padding: 10px; margin-top: 10px; text-align: left; background-color: #f9f9f9; border-radius: 5px; font-size: 0.9em; line-height: 1.4; }
        #controls { margin-top: 15px; }
        button, select, input { padding: 8px 15px; margin: 4px; font-size: 0.9em; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #e9e9e9; }
        button:active { background-color: #dcdcdc; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #player-hand { display: flex; flex-wrap: wrap; justify-content: center; margin-bottom: 15px; }
        .collected-boxes { margin-top: 15px; text-align: left; font-size: 0.9em; }
        .hidden { display: none !important; }
        .lobby-inputs input { width: 180px; }
        .lobby-inputs button { width: 370px; }

        /* –ù–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –æ—Ö–∞–π–Ω–æ–≥–æ –≤–∏–≥–ª—è–¥—É */
        h1 { margin-bottom: 10px; }
        p { margin: 5px 0; }
        ul { list-style-type: none; padding: 0; }
        ul li { margin: 3px 0; font-size: 0.9em; }
        #game-info { text-align: left; margin-top: 20px; }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –¥—ñ–∞–ª–æ–≥—É –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –≥—Ä–∏ */
        #game-end-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            text-align: center;
        }
        #game-end-dialog h2 { margin-top: 0; }
        #game-end-dialog button { margin-top: 20px; }
        /* üîΩ –í—ñ–¥—Å—Ç—É–ø –º—ñ–∂ –º–∞—Å—Ç—è–º–∏ —Ç–∞ –∫–Ω–æ–ø–∫–æ—é */
        #suits-checkboxes { 
            margin-bottom: 2em; /* –∑–º—ñ–Ω–∏ –Ω–∞ 1.5em —è–∫—â–æ —Ö–æ—á–µ—à –º–µ–Ω—à–∏–π –≤—ñ–¥—Å—Ç—É–ø */
            display: flex;
            justify-content: space-around; /* –∞–±–æ space-between –¥–ª—è —á—ñ—Ç–∫–æ–≥–æ —Ä–æ–∑–∫–∏–¥—É */
            max-width: 400px; /* –æ–±–º–µ–∂ —à–∏—Ä–∏–Ω—É, —â–æ–± –Ω–µ –±—É–ª–æ –∑–∞–Ω–∞–¥—Ç–æ —Ä–æ–∑—Ç—è–≥–Ω—É—Ç–æ */
            margin: 0 auto 2em auto; /* —Ü–µ–Ω—Ç—Ä –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—ñ + –≤—ñ–¥—Å—Ç—É–ø –∑–Ω–∏–∑—É */
                          }

    </style>
</head>
<body>
    <div class="game-container">
        <h1>–ì—Ä–∞ "–°–∫—Ä–∏–Ω—å–∫–∏"</h1>

        <div id="lobby">
            <p>–í–∏–±–µ—Ä—ñ—Ç—å —ñ–º'—è —Ç–∞ –∫—ñ–º–Ω–∞—Ç—É –¥–ª—è –≥—Ä–∏.</p>
            <div class="lobby-inputs">
                <input type="text" id="player-name-input" placeholder="–í–∞—à–µ —ñ–º'—è">
                <input type="text" id="room-id-input" placeholder="ID –∫—ñ–º–Ω–∞—Ç–∏">
                <button onclick="joinRoom()">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è / –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É</button>
            </div>
            <p id="lobby-message"></p>
        </div>

        <div id="game" style="display: none;">
            <div class="game-state-message" id="game-status">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –Ω–∞ –≥—Ä–∞–≤—Ü—ñ–≤...</div>
            
            <div id="controls">
                <div id="game-actions" style="display: none;">
                    <p>–í–∞—à —Ö—ñ–¥, <span id="current-player-name"></span>! –í–∏–±–µ—Ä—ñ—Ç—å –≥—Ä–∞–≤—Ü—è —Ç–∞ –∫–∞—Ä—Ç—É –¥–ª—è –∑–∞–ø–∏—Ç—É.</p>
                    <select id="target-player-select"></select>
                    <select id="card-rank-select">
                        <option value="">–í–∏–±—Ä–∞—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="J">J</option>
                        <option value="Q">Q</option>
                        <option value="K">K</option>
                        <option value="A">A</option>
                    </select>
                    <button onclick="askForCard()">–ó–∞–ø–∏—Ç–∞—Ç–∏</button>
                </div>

                <div id="guess-count" style="display: none;">
                    <p>–í–≥–∞–¥–∞–π—Ç–µ, —Å–∫—ñ–ª—å–∫–∏ –∫–∞—Ä—Ç –∑ —Ü–∏–º —Ä–∞–Ω–≥–æ–º —î —É –≤–∞—à–æ–≥–æ —Å—É–ø–µ—Ä–Ω–∏–∫–∞?</p>
                    <select id="card-count-select">  
                        <option value="">–í–∏–±—Ä–∞—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è</option>  
                        <option value="1">1</option>  
                        <option value="2">2</option>  
                        <option value="3">3</option>   
                    </select>   
                    <button id="submit-guess-count-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
                </div>
                
                <div id="guess-suits-form" style="display: none;">
                    <p>–°–∫—ñ–ª—å–∫–∏ –º–∞—Å—Ç–µ–π –≤–∏ –≤–≥–∞–¥–∞—î—Ç–µ?</p>
                    <div id="suits-checkboxes">
                        <label><input type="checkbox" name="suit" value="‚ô•"> ‚ô•</label>
                        <label><input type="checkbox" name="suit" value="‚ô¶"> ‚ô¶</label>
                        <label><input type="checkbox" name="suit" value="‚ô£"> ‚ô£</label>
                        <label><input type="checkbox" name="suit" value="‚ô†"> ‚ô†</label>
                    </div>
                    <button onclick="guessSuits()">–í–≥–∞–¥–∞—Ç–∏ –º–∞—Å—Ç—ñ</button>
                </div>

                <div id="response-buttons" style="display: none;">
                    <p>–ì—Ä–∞–≤–µ—Ü—å <span id="asking-player-name"></span> –∑–∞–ø–∏—Ç—É—î –∫–∞—Ä—Ç—É <span id="asked-card-rank"></span>. –£ –≤–∞—Å –≤–æ–Ω–∞ —î?</p>
                    <button onclick="respondToAsk('yes')">–¢–∞–∫</button>
                    <button onclick="respondToAsk('no')">–ù—ñ</button>
                </div>
            </div>

            <div id="game-info">
                <button id="startGameBtn" onclick="startGame()" >–†–æ–∑–ø–æ—á–∞—Ç–∏ –≥—Ä—É</button>
                <p><strong>–í–∞—à—ñ –∫–∞—Ä—Ç–∏:</strong></p>
                <div id="player-hand" class="card-container"></div>
                <p><strong>–ó—ñ–±—Ä–∞–Ω—ñ —Å–∫—Ä–∏–Ω—å–∫–∏:</strong></p>
                <div id="collected-boxes" class="collected-boxes"></div>
                <p><strong>–ö–æ–ª–æ–¥–∞:</strong> <span id="deck-size"></span> –∫–∞—Ä—Ç</p>
                <p><strong>–ì—Ä–∞–≤—Ü—ñ:</strong></p>
                <ul id="players-list"></ul>
            </div>
        </div>
        
        <div id="game-end-dialog" style="display: none;">
            <h2 id="winner-name"></h2>
            <button onclick="startNewGame()">–ù–æ–≤–∞ –≥—Ä–∞</button>
            <button onclick="closeGameDialog()">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>

        <div class="message-box">
            <h4>–ñ—É—Ä–Ω–∞–ª –≥—Ä–∏:</h4>
            <div id="log"></div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        const WS_URL = "wss://telegram-webapp-beispiel.onrender.com";
        let socket;
        let telegramUser = '';
        let myName = '';
        let myRoomId = '';

        const elements = {
            lobby: document.getElementById('lobby'),
            game: document.getElementById('game'),
            playerNameInput: document.getElementById('player-name-input'),
            roomIdInput: document.getElementById('room-id-input'),
            lobbyMessage: document.getElementById('lobby-message'),
            gameStatus: document.getElementById('game-status'),
            startGameBtn: document.getElementById('startGameBtn'),
            gameActions: document.getElementById('game-actions'),
            playerHand: document.getElementById('player-hand'),
            collectedBoxes: document.getElementById('collected-boxes'),
            playersList: document.getElementById('players-list'),
            deckSize: document.getElementById('deck-size'),
            log: document.getElementById('log'),
            targetPlayerSelect: document.getElementById('target-player-select'),
            cardRankSelect: document.getElementById('card-rank-select'),
            guessSuitsForm: document.getElementById('guess-suits-form'),
            guessCount: document.getElementById('guess-count'),
            guessCountInput: document.getElementById('card-count-select'),
            submitGuessCountBtn: document.getElementById('submit-guess-count-btn'),
            suitsCheckboxes: document.getElementById('suits-checkboxes'),
            responseButtons: document.getElementById('response-buttons'),
            askingPlayerName: document.getElementById('asking-player-name'),
            askedCardRank: document.getElementById('asked-card-rank'),
            gameEndDialog: document.getElementById('game-end-dialog'),
            winnerName: document.getElementById('winner-name'),
            currentPlayerName: document.getElementById('current-player-name'), // –î–æ–¥–∞–Ω–æ
        };

        if (tg) {
            tg.ready();
            tg.expand();
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const u = tg.initDataUnsafe.user;
                telegramUser = u.username ? `@${u.username}` : (u.first_name || '–ì—Ä–∞–≤–µ—Ü—å');
                elements.playerNameInput.value = telegramUser;
            } else {
                telegramUser = "–ê–Ω–æ–Ω—ñ–º–Ω–∏–π –≥—Ä–∞–≤–µ—Ü—å";
            }
        } else {
            telegramUser = "–¢–µ—Å—Ç–æ–≤–∏–π –≥—Ä–∞–≤–µ—Ü—å";
        }

        function closeGameDialog() {
            if (elements.gameEndDialog) {
                elements.gameEndDialog.style.display = 'none';
            }
        }
        
        function logMessage(message) {
            const p = document.createElement('p');
            p.textContent = message;
            elements.log.appendChild(p);
            elements.log.scrollTop = elements.log.scrollHeight;
        }

        function updateUI(state, myHand) {
            elements.playersList.innerHTML = '';
            state.players.forEach(p => {
                const li = document.createElement('li');
                li.textContent = `${p.name} (${p.is_turn ? '–•–æ–¥–∏—Ç—å' : '–û—á—ñ–∫—É—î'}) - –°–∫—Ä–∏–Ω—å–æ–∫: ${p.collected_boxes}`;
                elements.playersList.appendChild(li);
            });

            // –î–æ–¥–∞–π—Ç–µ —Ü–µ–π —Ä—è–¥–æ–∫ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–º–µ–Ω—ñ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –≥—Ä–∞–≤—Ü—è
            elements.currentPlayerName.textContent = state.current_turn;
            
            elements.playerHand.innerHTML = '';
            if (myHand && myHand.length > 0) {
                myHand.forEach(card => {
                    const div = document.createElement('div');
                    div.className = `card ${card.includes('‚ô•') || card.includes('‚ô¶') ? 'hearts' : 'clubs'}`;
                    div.textContent = card;
                    elements.playerHand.appendChild(div);
                });
            } else {
                elements.playerHand.textContent = '–£ –≤–∞—Å –Ω–µ–º–∞—î –∫–∞—Ä—Ç –Ω–∞ —Ä—É–∫–∞—Ö.';
            }
            
            elements.collectedBoxes.innerHTML = '';
            const myPlayerState = state.players.find(p => p.name === myName);
            if (myPlayerState && myPlayerState.collected_sets.length > 0) {
                myPlayerState.collected_sets.forEach(rank => {
                    const p = document.createElement('p');
                    p.textContent = `–ó—ñ–±—Ä–∞–Ω–æ —Å–∫—Ä–∏–Ω—å–∫—É: ${rank}`;
                    elements.collectedBoxes.appendChild(p);
                });
            }

            elements.deckSize.textContent = state.deck_size;
            elements.gameStatus.textContent = state.game_started ? `–ì—Ä–∞ —Ä–æ–∑–ø–æ—á–∞–ª–∞—Å—å! –•—ñ–¥ –≥—Ä–∞–≤—Ü—è: ${state.current_turn}` : `–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –Ω–∞ –≥—Ä–∞–≤—Ü—ñ–≤... (–í—Å—å–æ–≥–æ ${state.players.length}/6)`;
            
            handleStartGameButton(state);
            
            hideAllControls();

            if (state.game_started && state.current_turn === myName) {
                elements.gameActions.style.display = 'block';
                elements.targetPlayerSelect.innerHTML = state.players
                    .filter(p => p.name !== myName)
                    .map(p => `<option value="${p.name}">${p.name}</option>`)
                    .join('');
            }
        }

        function handleStartGameButton(state) {
            const isRoomAdmin = state.room_admin === myName;
            
            if (isRoomAdmin && !state.game_started) {
                elements.gameActions.style.display = 'block';
                elements.startGameBtn.disabled = state.players.length < 2;
            } else {
                elements.startGameBtn.style.display = 'none';
            }
        }

        function hideAllControls() {
            elements.gameActions.style.display = 'none';
¬† ¬† ¬† ¬† ¬† ¬† //elements.guessCount.style.display = 'none';
¬† ¬† ¬† ¬† ¬† ¬† //elements.guessSuitsForm.style.display = 'none';
¬† ¬† ¬† ¬† ¬† ¬† elements.responseButtons.style.display = 'none';
        }

        function joinRoom() {
            myName = elements.playerNameInput.value.trim();
            myRoomId = elements.roomIdInput.value.trim();

            if (myName && myRoomId) {
                connectWebSocket();
            } else {
                elements.lobbyMessage.textContent = '–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —ñ–º\'—è —Ç–∞ ID –∫—ñ–º–Ω–∞—Ç–∏.';
            }
        }
        
        function addLogEntry(message) {
            const p = document.createElement('p');
            p.textContent = message;
            elements.log.appendChild(p);
            elements.log.scrollTop = elements.log.scrollHeight;
        }

        function connectWebSocket() {
            socket = new WebSocket(WS_URL);
            
            socket.onopen = () => {
                addLogEntry("–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ —Å–µ—Ä–≤–µ—Ä–∞. –ù–∞–¥—Å–∏–ª–∞—î–º–æ —ñ–º'—è –≥—Ä–∞–≤—Ü—è —Ç–∞ ID –∫—ñ–º–Ω–∞—Ç–∏...");
                const message_to_send = { type: 'join', name: myName, room: myRoomId };
                socket.send(JSON.stringify(message_to_send));
            };
            
            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                addLogEntry(`–û—Ç—Ä–∏–º–∞–Ω–æ: ${JSON.stringify(data)}`);
                
                switch (data.type) {
                    case 'joined_room':
                        elements.lobby.style.display = 'none';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† elements.game.style.display = 'block';
                        addLogEntry(`–ü—Ä–∏—î–¥–Ω–∞–Ω–æ –¥–æ –∫—ñ–º–Ω–∞—Ç–∏: ${myRoomId}`);
                        break;
                    case 'update_state':
                        updateUI(data.state, data.state.my_hand);
                        break;
                    case 'game_over':
                        elements.game.style.display = 'none';
                        elements.gameEndDialog.style.display = 'block';
                        elements.winnerName.textContent = `–ì—Ä–∞ –∑–∞–∫—ñ–Ω—á–µ–Ω–∞! –ü–µ—Ä–µ–º–æ–∂–µ—Ü—å: ${data.winner}.`;
                        break;
                    case 'ask_response_needed':
                        hideAllControls();
                        elements.responseButtons.style.display = 'block';
                        elements.askingPlayerName.textContent = data.asking_player;
                        elements.askedCardRank.textContent = data.card_rank;
                        break;
                    case 'guess_count_needed':
                        hideAllControls();
                        elements.guessCount.style.display = 'block';
                        break;
                    case 'guess_suits_needed':
                        hideAllControls();
                        elements.guessSuitsForm.style.display = 'block';
                        break;
                    case 'log':
                        addLogEntry(data.message);
                        break;
                    case 'error':
                        addLogEntry(`–ü–æ–º–∏–ª–∫–∞: ${data.message}`);
                        break;
                }
            };

            socket.onclose = () => {
                addLogEntry("–í—ñ–¥–∫–ª—é—á–µ–Ω–æ –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞. –°–ø—Ä–æ–±–∞ –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...");
                setTimeout(connectWebSocket, 5000);
            };
            
            socket.onerror = (error) => {
                addLogEntry(`–ü–æ–º–∏–ª–∫–∞ WebSocket: ${error}`);
            };
        }

        function startGame() {
            if (socket.readyState === WebSocket.OPEN) {
                const message_to_send = { type: 'start_game', room: myRoomId };
                socket.send(JSON.stringify(message_to_send));
            }
        }
        
        function startNewGame() {
            elements.gameEndDialog.style.display = 'none';
            elements.game.style.display = 'block';
            startGame();
        }

        function askForCard() {
            const targetPlayer = elements.targetPlayerSelect.value;
            const cardRank = elements.cardRankSelect.value;
            if (targetPlayer && cardRank) {
                const message_to_send = {type: 'ask_card', room: myRoomId, target: targetPlayer, card_rank: cardRank };
                socket.send(JSON.stringify(message_to_send));
            } else {
                addLogEntry('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –≥—Ä–∞–≤—Ü—è —Ç–∞ –∑–Ω–∞—á–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏.');
            }
        }
        
        function respondToAsk(response) {
            socket.send(JSON.stringify({ type: 'ask_response', room: myRoomId, response: response }));
            hideAllControls();
        }

        function guessSuits() {
            const suits = Array.from(elements.suitsCheckboxes.querySelectorAll('input:checked')).map(cb => cb.value);
            if (suits.length > 0) {
                const message_to_send = { type: 'guess_suits', room: myRoomId, suits: suits };
                socket.send(JSON.stringify(message_to_send));
                elements.guessSuitsForm.style.display = 'none';
            } else {
                addLogEntry('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –º–∞—Å—Ç—ñ.');
            }
        }

        elements.submitGuessCountBtn.onclick = () => {
            const count = parseInt(elements.guessCountInput.value, 10);
            if (!isNaN(count)) {
                const message_to_send = { type: 'guess_count', room: myRoomId, count: count };
                socket.send(JSON.stringify(message_to_send));
                elements.guessCount.style.display = 'none';
            } else {
                addLogEntry('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –∫—ñ–ª—å–∫—ñ—Å—Ç—å.');
            }
        };
    </script>
</body>
</html>
